<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 11 Clone</title>
    <style>
        :root {
            --bg-color: #f3f3f3;
            --taskbar-bg: rgba(243, 243, 243, 0.85);
            --window-bg: rgba(255, 255, 255, 0.98);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --primary-color: #0067c0;
            --text-color: #222;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Fallback color if image doesn't load */
            background-color: #004e98; 
            /* Windows 11 Bloom Wallpaper URL */
            background-image: url('https://images.unsplash.com/photo-1618331835717-801e976710b2?q=80&w=2070&auto=format&fit=crop');
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: cover;
            height: 100vh;
            width: 100vw;
        }

        /* --- Desktop Icons --- */
        .desktop-icons {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 10; /* Ensure above background */
        }

        .desktop-icon {
            width: 80px;
            height: 95px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.1s;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            padding: 5px;
        }

        .desktop-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .desktop-icon.selected {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .icon-img {
            width: 48px;
            height: 48px;
            margin-bottom: 8px;
            /* Flex center for SVGs */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-img svg {
            width: 100%;
            height: 100%;
            drop-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .icon-label {
            font-size: 13px;
            text-align: center;
            line-height: 1.2;
            word-wrap: break-word;
            width: 100%;
        }

        /* --- Taskbar --- */
        .taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 48px;
            background: var(--taskbar-bg);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 9999;
            border-top: 1px solid rgba(255,255,255,0.4);
        }

        .start-group {
            display: flex;
            align-items: center;
            gap: 8px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            height: 100%;
        }

        .taskbar-icon {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .taskbar-icon svg {
            width: 26px;
            height: 26px;
        }

        .taskbar-icon:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }

        .taskbar-icon:active {
            transform: scale(0.9);
        }

        .taskbar-icon.open::after {
            content: '';
            position: absolute;
            bottom: 3px;
            width: 6px;
            height: 3px;
            background: #0067c0;
            border-radius: 2px;
            transition: width 0.2s;
        }

        .taskbar-icon.active {
            background-color: rgba(255, 255, 255, 0.6);
        }

        .taskbar-icon.active::after {
            width: 16px;
        }

        /* System Tray */
        .system-tray {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #333;
        }

        .tray-icon {
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .tray-icon:hover { background: rgba(0,0,0,0.05); }

        .clock-area {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            cursor: pointer;
            padding: 0 8px;
            border-radius: 4px;
        }
        .clock-area:hover { background: rgba(255,255,255,0.5); }

        /* --- Start Menu --- */
        .start-menu {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            width: 640px;
            height: 700px;
            max-height: 85vh;
            background: rgba(243, 243, 243, 0.95);
            backdrop-filter: blur(30px);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 0 20px rgba(0,0,0,0.25);
            display: none;
            flex-direction: column;
            padding: 24px;
            z-index: 9998;
            opacity: 0;
            transition: all 0.2s cubic-bezier(0.1, 0.9, 0.2, 1);
        }

        .start-menu.visible {
            display: flex;
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .search-bar {
            background: #fff;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .search-bar input {
            border: none;
            outline: none;
            width: 100%;
            margin-left: 10px;
            font-family: inherit;
        }

        .pinned-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            padding: 10px 0;
        }

        .pinned-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .pinned-item:hover { background: rgba(255,255,255,0.5); }
        .pinned-item span { font-size: 11px; color: #333; }
        .pinned-item svg { width: 32px; height: 32px; }

        /* --- Windows --- */
        .window {
            position: absolute;
            background: var(--window-bg);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(100, 100, 100, 0.2);
            display: flex;
            flex-direction: column;
            min-width: 300px;
            min-height: 200px;
            overflow: hidden;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.15s, transform 0.15s;
            animation: popIn 0.2s forwards;
            resize: both;
        }

        @keyframes popIn {
            to { opacity: 1; transform: scale(1); }
        }

        .title-bar {
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 0 0 12px;
            background: transparent;
        }

        .title-drag-area {
            flex-grow: 1;
            height: 100%;
            display: flex;
            align-items: center;
            font-size: 13px;
            color: #333;
        }
        .title-drag-area svg {
            width: 16px;
            height: 16px;
            margin-right: 10px;
        }

        .window-controls {
            display: flex;
            height: 100%;
        }

        .control-btn {
            width: 46px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            color: #333;
        }

        .control-btn:hover { background: #e5e5e5; }
        .control-btn.close:hover { background: #c42b1c; color: white; }

        .window-content {
            flex-grow: 1;
            position: relative;
            background: #fff;
            overflow: auto;
            cursor: auto;
            border-top: 1px solid #eee;
        }
        
        /* App Specific Styles */

        /* MS Word */
        .word-toolbar {
            background: #f3f3f3;
            padding: 8px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 5px;
        }
        .tool-btn {
            padding: 4px 8px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .tool-btn:hover { background: #e9e9e9; }
        .word-doc {
            width: 100%;
            height: 100%;
            padding: 60px 80px;
            outline: none;
            font-family: 'Calibri', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            box-shadow: 0 0 10px rgba(0,0,0,0.05) inset;
        }

        /* Paint */
        .paint-toolbar {
            height: 50px;
            background: #f5f6f7;
            border-bottom: 1px solid #dcdcdc;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 15px;
        }
        .color-picker {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
            overflow: hidden;
        }
        .color-picker input {
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        #canvas-container {
            width: 100%;
            height: calc(100% - 50px);
            background: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }
        canvas {
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            cursor: crosshair;
        }

        /* Calculator */
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            height: 100%;
            background: #f3f3f3;
            padding: 2px;
        }
        .calc-display {
            grid-column: span 4;
            background: #f3f3f3;
            text-align: right;
            padding: 20px;
            font-size: 36px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            font-family: 'Segoe UI Semibold', sans-serif;
        }
        .calc-btn {
            background: #fff;
            border: 1px solid #f9f9f9;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.1s;
        }
        .calc-btn:hover { background: #f0f0f0; }
        .calc-btn.op { background: #f9f9f9; }
        .calc-btn.op:hover { background: #e5e5e5; }
        .calc-btn.eq { background: #0067c0; color: white; }
        .calc-btn.eq:hover { background: #005a9e; }

        /* Chrome */
        .chrome-nav {
            background: #f1f3f4;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .nav-btn { font-size: 14px; color: #5f6368; cursor: pointer; padding: 4px; border-radius: 50%; }
        .nav-btn:hover { background: #e0e0e0; }
        .address-bar {
            flex-grow: 1;
            background: #fff;
            border-radius: 20px;
            padding: 6px 15px;
            font-size: 13px;
            color: #333;
            border: 1px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
        }
        .address-bar:focus-within {
            border: 1px solid #1a73e8;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .address-input {
            border: none;
            outline: none;
            width: 100%;
            margin-left: 8px;
        }
        .chrome-body {
            height: calc(100% - 44px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
        }
        .google-logo {
            font-size: 64px;
            font-weight: bold;
            color: #4285f4;
            letter-spacing: -2px;
            margin-bottom: 20px;
        }
        .google-logo span:nth-child(2) { color: #ea4335; }
        .google-logo span:nth-child(3) { color: #fbbc05; }
        .google-logo span:nth-child(4) { color: #4285f4; }
        .google-logo span:nth-child(5) { color: #34a853; }
        .google-logo span:nth-child(6) { color: #ea4335; }
        
        .fake-search-box {
            width: 50%;
            padding: 12px 20px;
            border-radius: 24px;
            border: 1px solid #dfe1e5;
            display: flex;
            justify-content: space-between;
        }
        .fake-search-box:hover { box-shadow: 0 1px 6px rgba(32,33,36,0.28); }

        .google-home {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        /* Photoshop Clone Styles */
        .ps-app-container {
            display: flex;
            width: 100%;
            height: 100%;
            background: #333; /* Dark background for professional feel */
        }
        .ps-toolbar-left {
            width: 50px;
            background: #505050;
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }
        .ps-tool-icon {
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            font-size: 20px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.1s;
        }
        .ps-tool-icon:hover { background: #606060; }
        .ps-tool-icon.active { background: #3c78d8; color: white; }

        #ps-color-picker {
            width: 40px;
            height: 40px;
            border: 3px solid #ccc;
            padding: 0;
            cursor: pointer;
        }
        #ps-brush-size {
            width: 90%;
            margin-top: 5px;
        }
        
        .ps-canvas-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #444;
            position: relative;
            overflow: hidden;
            border: 1px solid #222;
        }
        .ps-canvas {
            position: absolute;
            background: transparent;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            /* Initial Canvas size - fixed */
            width: 700px;
            height: 500px;
        }

        /* Temp canvas for drawing guides/shapes */
        #ps-temp-canvas {
            position: absolute;
            width: 700px;
            height: 500px;
            pointer-events: none; /* Allows clicks to pass through to the drawing layers */
            z-index: 999;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .ps-sidebar-right {
            width: 250px;
            background: #505050;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            border-left: 1px solid #444;
        }
        .ps-panel-header {
            background: #606060;
            color: white;
            padding: 8px 10px;
            font-size: 14px;
            font-weight: 600;
        }
        .ps-layers-panel {
            flex-grow: 1;
            padding: 5px;
            overflow-y: auto;
        }
        .ps-layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #404040;
            color: white;
            padding: 8px;
            margin-bottom: 2px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
        }
        .ps-layer-item:hover { background: #555; }
        .ps-layer-item.active { 
            background: #3c78d8; 
            border: 1px solid #3162b8;
        }
        .ps-layer-item span {
            display: flex;
            align-items: center;
        }
        
        /* SVG Icons Helper Classes */
        .icon-svg { width: 100%; height: 100%; }
    </style>
</head>
<body>

    <!-- Desktop Area -->
    <div class="desktop-icons" id="desktop-icons">
        <!-- Icons injected by JS -->
    </div>

    <!-- Windows Container -->
    <div id="windows-container"></div>

    <!-- Start Menu -->
    <div class="start-menu" id="start-menu">
        <div class="search-bar">
            <span>üîç</span>
            <input type="text" placeholder="Type here to search">
        </div>
        <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #444;">Pinned</div>
        <div class="pinned-grid" id="start-pinned">
            <!-- Pinned items injected by JS -->
        </div>
    </div>

    <!-- Taskbar -->
    <div class="taskbar">
        <div class="start-group" id="taskbar-icons">
            <!-- Windows Start Button (Blue SVG) -->
            <div class="taskbar-icon" onclick="toggleStartMenu()" title="Start">
                <svg viewBox="0 0 24 24" fill="none">
                    <path fill="#00a4ef" d="M0 0h11v11H0z"/>
                    <path fill="#7fba00" d="M13 0h11v11H13z"/>
                    <path fill="#f25022" d="M0 13h11v11H0z"/>
                    <path fill="#ffb900" d="M13 13h11v11H13z"/>
                </svg>
            </div>
            <!-- Dynamic Taskbar Icons will go here -->
        </div>

        <div class="system-tray">
            <div class="tray-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 15l-6-6-6 6"/>
                </svg>
            </div>
            <div class="tray-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12.55a11 11 0 0 1 14.08 0"/>
                    <path d="M1.42 9a16 16 0 0 1 21.16 0"/>
                    <path d="M8.53 16.11a6 6 0 0 1 6.95 0"/>
                    <line x1="12" y1="20" x2="12.01" y2="20"/>
                </svg>
            </div>
            <div class="tray-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                </svg>
            </div>
            <div class="clock-area">
                <span id="clock-time" style="font-weight: 500;">12:00 PM</span>
                <span id="clock-date" style="font-weight: 400;">10/25/2023</span>
            </div>
        </div>
    </div>

    <script>
        // --- SVG Constants for Icons ---
        
        const WORD_ICON = `
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="4" y="4" width="56" height="56" rx="4" fill="#2B579A"/>
            <path d="M20 16h24v4H20zM20 24h30v4H20zM20 32h30v4H20zM20 40h24v4H20z" fill="white" fill-opacity="0.3"/>
            <rect x="8" y="16" width="28" height="28" rx="2" fill="white"/>
            <path d="M16 22l3 16h3l3-9 3 9h3l3-16h-4l-1.5 10-2.5-10h-3l-2.5 10-1.5-10H16z" fill="#2B579A"/>
        </svg>`;

        const PAINT_ICON = `
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M32 4C16.5 4 4 16.5 4 32s12.5 28 28 28c3 0 4-2 4-4v-4c0-2 2-4 4-4h4c8.8 0 16-7.2 16-16 0-15.5-12.5-28-28-28z" fill="url(#paint_grad)"/>
            <circle cx="18" cy="22" r="4" fill="#FF5252"/>
            <circle cx="14" cy="34" r="4" fill="#448AFF"/>
            <circle cx="26" cy="46" r="4" fill="#69F0AE"/>
            <circle cx="46" cy="22" r="4" fill="#FFD740"/>
            <defs>
                <linearGradient id="paint_grad" x1="4" y1="4" x2="60" y2="60" gradientUnits="userSpaceOnUse">
                    <stop offset="0" stop-color="#FFF8E1"/>
                    <stop offset="1" stop-color="#FFE082"/>
                </linearGradient>
            </defs>
            <path d="M44 48l12-12m-12 12l-4 4m16-16l4 4" stroke="#795548" stroke-width="4" stroke-linecap="round"/>
        </svg>`;

        const CHROME_ICON = `
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="32" cy="32" r="28" fill="white"/>
            <path d="M32 32l16.8-9.6A19.2 19.2 0 0 1 51.2 32c0 10.6-8.6 19.2-19.2 19.2-3.8 0-7.3-1.1-10.4-3L32 32z" fill="#4CAF50"/>
            <path d="M32 32A19.2 19.2 0 0 1 32 12.8c4.6 0 8.9 1.6 12.3 4.3L32 32z" fill="#F44336"/>
            <path d="M32 32L14.4 32A19.2 19.2 0 0 1 32 12.8c4.6 0 8.9 1.6 12.3 4.3L32 32z" fill="#F44336"/>
            <path d="M32 32l-8.8 15.2A19.2 19.2 0 0 1 12.8 32c0-4.6 1.6-8.9 4.3-12.3L32 32z" fill="#FFC107"/>
            <circle cx="32" cy="32" r="8.5" fill="white"/>
            <circle cx="32" cy="32" r="6.5" fill="#2196F3"/>
        </svg>`;

        const CALC_ICON = `
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="10" y="4" width="44" height="56" rx="6" fill="#424242"/>
            <rect x="14" y="10" width="36" height="12" rx="2" fill="#A5D6A7"/>
            <rect x="14" y="26" width="8" height="8" rx="2" fill="#757575"/>
            <rect x="24" y="26" width="8" height="8" rx="2" fill="#757575"/>
            <rect x="34" y="26" width="8" height="8" rx="2" fill="#757575"/>
            <rect x="44" y="26" width="6" height="8" rx="2" fill="#FFAB91"/>
            
            <rect x="14" y="36" width="8" height="8" rx="2" fill="#E0E0E0"/>
            <rect x="24" y="36" width="8" height="8" rx="2" fill="#E0E0E0"/>
            <rect x="34" y="36" width="8" height="8" rx="2" fill="#E0E0E0"/>
            <rect x="44" y="36" width="6" height="8" rx="2" fill="#FFAB91"/>

            <rect x="14" y="46" width="8" height="8" rx="2" fill="#E0E0E0"/>
            <rect x="24" y="46" width="8" height="8" rx="2" fill="#E0E0E0"/>
            <rect x="34" y="46" width="8" height="8" rx="2" fill="#E0E0E0"/>
            <rect x="44" y="46" width="6" height="12" rx="2" fill="#81D4FA"/>
        </svg>`;

        const PS_ICON = `
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="4" y="4" width="56" height="56" rx="8" fill="#31C3F7"/>
            <path d="M18 16L32 48L46 16H38L32 32L26 16H18Z" fill="white"/>
            <path d="M46 16L50 48H58L54 16H46Z" fill="#00A2EE"/>
            <path d="M14 48L18 16H6L10 48H14Z" fill="#007ACC"/>
            <text x="32" y="58" font-family="Arial" font-size="20" font-weight="bold" fill="white" text-anchor="middle" style="user-select:none;">Ps</text>
        </svg>`;

        // --- Configuration ---
        const apps = {
            'word': {
                id: 'word',
                title: 'Word',
                iconSvg: WORD_ICON,
                width: 700,
                height: 500,
                content: `
                    <div style="display:flex; flex-direction:column; height:100%;">
                        <div class="word-toolbar">
                            <button class="tool-btn" onclick="document.execCommand('bold')"><b>B</b></button>
                            <button class="tool-btn" onclick="document.execCommand('italic')"><i>I</i></button>
                            <button class="tool-btn" onclick="document.execCommand('underline')"><u>U</u></button>
                            <div style="width:1px; background:#ccc; margin:0 5px;"></div>
                            <button class="tool-btn" onclick="document.execCommand('justifyLeft')">L</button>
                            <button class="tool-btn" onclick="document.execCommand('justifyCenter')">C</button>
                            <button class="tool-btn" onclick="document.execCommand('justifyRight')">R</button>
                        </div>
                        <div class="word-doc" contenteditable="true">
                            <h2>Document 1</h2>
                            <p>Type your text here...</p>
                        </div>
                    </div>
                `
            },
            'paint': {
                id: 'paint',
                title: 'Paint',
                iconSvg: PAINT_ICON,
                width: 800,
                height: 600,
                content: `
                    <div style="height:100%; display:flex; flex-direction:column;">
                        <div class="paint-toolbar">
                            <label style="font-size:12px;">Color:</label>
                            <div class="color-picker" style="background:black;"><input type="color" id="paint-color" onchange="this.parentElement.style.background=this.value"></div>
                            <label style="font-size:12px;">Size:</label>
                            <input type="range" id="paint-size" min="1" max="50" value="5">
                            <button class="tool-btn" onclick="clearCanvas()">Clear</button>
                        </div>
                        <div id="canvas-container">
                            <canvas id="paint-canvas" width="700" height="500"></canvas>
                        </div>
                    </div>
                `,
                init: initPaint
            },
            'chrome': {
                id: 'chrome',
                title: 'Chrome',
                iconSvg: CHROME_ICON,
                width: 900,
                height: 600,
                content: `
                    <div style="height:100%; display:flex; flex-direction:column;">
                        <div class="chrome-nav">
                            <span class="nav-btn" onclick="chromeHome()">üè†</span>
                            <span class="nav-btn" onclick="chromeHome()">‚Üª</span>
                            <div class="address-bar">
                                üîí <input id="chrome-url-bar" class="address-input" type="text" value="https://www.google.com">
                            </div>
                        </div>
                        <div class="chrome-body" id="chrome-body-content">
                            <div class="google-home" id="chrome-home-view">
                                <div class="google-logo">
                                    <span>G</span><span>o</span><span>o</span><span>g</span><span>l</span><span>e</span>
                                </div>
                                <div class="fake-search-box">
                                    <input type="text" id="chrome-search-input" placeholder="Search Google or type a URL" style="border:none; outline:none; width:90%; font-size:16px; font-family:inherit;">
                                    <span>üé§</span>
                                </div>
                            </div>
                            <iframe id="chrome-iframe" src="" style="width:100%; height:100%; border:none; display:none;"></iframe>
                        </div>
                    </div>
                `,
                init: initChrome
            },
            'calc': {
                id: 'calc',
                title: 'Calculator',
                iconSvg: CALC_ICON,
                width: 320,
                height: 480,
                content: `
                    <div class="calc-grid">
                        <div class="calc-display" id="calc-display">0</div>
                        <button class="calc-btn op" onclick="calcAppend('C')">C</button>
                        <button class="calc-btn op" onclick="calcAppend('(')">(</button>
                        <button class="calc-btn op" onclick="calcAppend(')')">)</button>
                        <button class="calc-btn op" onclick="calcAppend('/')">√∑</button>
                        
                        <button class="calc-btn" onclick="calcAppend('7')">7</button>
                        <button class="calc-btn" onclick="calcAppend('8')">8</button>
                        <button class="calc-btn" onclick="calcAppend('9')">9</button>
                        <button class="calc-btn op" onclick="calcAppend('*')">√ó</button>
                        
                        <button class="calc-btn" onclick="calcAppend('4')">4</button>
                        <button class="calc-btn" onclick="calcAppend('5')">5</button>
                        <button class="calc-btn" onclick="calcAppend('6')">6</button>
                        <button class="calc-btn op" onclick="calcAppend('-')">-</button>
                        
                        <button class="calc-btn" onclick="calcAppend('1')">1</button>
                        <button class="calc-btn" onclick="calcAppend('2')">2</button>
                        <button class="calc-btn" onclick="calcAppend('3')">3</button>
                        <button class="calc-btn op" onclick="calcAppend('+')">+</button>
                        
                        <button class="calc-btn" style="grid-column: span 2;" onclick="calcAppend('0')">0</button>
                        <button class="calc-btn" onclick="calcAppend('.')">.</button>
                        <button class="calc-btn eq" onclick="calcSolve()">=</button>
                    </div>
                `
            },
            'photoshop': {
                id: 'photoshop',
                title: 'Photoshop',
                iconSvg: PS_ICON,
                width: 1000,
                height: 700,
                content: `
                    <div class="ps-app-container">
                        <div class="ps-toolbar-left" id="ps-toolbar">
                            <div class="ps-tool-icon active" data-tool="brush" title="Brush (B)" onclick="switchTool(this, 'brush')">üñåÔ∏è</div>
                            <div class="ps-tool-icon" data-tool="eraser" title="Eraser (E)" onclick="switchTool(this, 'eraser')">üßΩ</div>
                            <div class="ps-tool-icon" data-tool="rectangle" title="Rectangle (M)" onclick="switchTool(this, 'rectangle')">üü¶</div>
                            <div class="ps-tool-icon" data-tool="fill" title="Fill Bucket (G)" onclick="applyFill(null)">üß∫</div>
                            <div class="ps-tool-icon" data-tool="eyedropper" title="Eyedropper (I)" onclick="switchTool(this, 'eyedropper')">üëÅÔ∏è</div>
                            <div class="ps-tool-icon" data-tool="move" title="Move (V)" onclick="switchTool(this, 'move')">‚á±</div>
                            <hr style="width:80%; border-color:#666; margin: 10px 0;">
                            <label style="color:white; font-size:10px;">Color</label>
                            <input type="color" id="ps-color-picker" value="#ff0000" title="Foreground Color">
                            <label style="color:white; font-size:10px;">Size</label>
                            <input type="range" id="ps-brush-size" min="1" max="50" value="10" title="Brush Size">
                            <button onclick="applyGrayscale()" class="tool-btn" style="margin-top:20px; width:40px; height:30px; background:#606060; color:white; border:none; border-radius:4px; font-size:10px;">Gray</button>
                            <button onclick="addNewLayer()" class="tool-btn" style="margin-top:10px; width:40px; height:30px; background:#606060; color:white; border:none; border-radius:4px; font-size:10px;">+Lyr</button>
                        </div>
                        <div class="ps-canvas-area" id="ps-canvas-area">
                            <canvas id="ps-temp-canvas" width="700" height="500"></canvas>
                            <!-- Canvases (layers) will be injected here -->
                        </div>
                        <div class="ps-sidebar-right">
                            <div class="ps-panel-header">Layers</div>
                            <div class="ps-layers-panel" id="ps-layers-panel">
                                <!-- Layers will be injected here -->
                            </div>
                        </div>
                    </div>
                `,
                init: initPhotoshop
            }
        };

        let zIndexCounter = 100;
        let openWindows = {};

        // --- Initialization ---
        function init() {
            renderDesktopIcons();
            renderTaskbarIcons();
            renderStartMenu();
            updateClock();
            setInterval(updateClock, 1000);
        }

        // --- Rendering ---
        function renderDesktopIcons() {
            const container = document.getElementById('desktop-icons');
            container.innerHTML = '';
            Object.values(apps).forEach(app => {
                const icon = document.createElement('div');
                icon.className = 'desktop-icon';
                icon.ondblclick = () => openWindow(app.id);
                icon.onclick = (e) => {
                    document.querySelectorAll('.desktop-icon').forEach(el => el.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                };

                icon.innerHTML = `
                    <div class="icon-img">${app.iconSvg}</div>
                    <div class="icon-label">${app.title}</div>
                `;
                container.appendChild(icon);
            });
        }

        function renderTaskbarIcons() {
            const container = document.getElementById('taskbar-icons');
            // Remove old dynamic icons but keep Start Button
            while(container.children.length > 1) {
                container.removeChild(container.lastChild);
            }

            Object.values(apps).forEach(app => {
                const icon = document.createElement('div');
                icon.className = 'taskbar-icon';
                icon.id = `taskbar-${app.id}`;
                icon.title = app.title;
                icon.onclick = () => toggleWindow(app.id);
                
                icon.innerHTML = app.iconSvg;
                container.appendChild(icon);
            });
        }

        function renderStartMenu() {
            const container = document.getElementById('start-pinned');
            container.innerHTML = '';
            Object.values(apps).forEach(app => {
                const item = document.createElement('div');
                item.className = 'pinned-item';
                item.onclick = () => { openWindow(app.id); toggleStartMenu(); };
                
                item.innerHTML = `
                    ${app.iconSvg}
                    <span>${app.title}</span>
                `;
                container.appendChild(item);
            });
        }

        // --- Window Management ---
        function openWindow(appId) {
            const app = apps[appId];
            if (openWindows[appId]) {
                bringToFront(appId);
                const win = document.getElementById(`window-${appId}`);
                win.style.display = 'flex';
                // Reset Animation
                win.style.animation = 'none';
                win.offsetHeight; 
                win.style.animation = 'popIn 0.2s forwards';
                return;
            }

            // Create Window
            const win = document.createElement('div');
            win.className = 'window';
            win.id = `window-${appId}`;
            win.style.width = app.width + 'px';
            win.style.height = app.height + 'px';
            // Offset position slightly
            const offset = Object.keys(openWindows).length * 20 + 50;
            win.style.top = offset + 'px';
            win.style.left = offset + 'px';
            win.style.zIndex = ++zIndexCounter;
            
            win.innerHTML = `
                <div class="title-bar" onmousedown="startDrag(event, '${appId}')">
                    <div class="title-drag-area">
                        ${app.iconSvg}
                        ${app.title}
                    </div>
                    <div class="window-controls">
                        <div class="control-btn" onclick="minimizeWindow('${appId}')">‚îÄ</div>
                        <div class="control-btn" onclick="toggleMaximize('${appId}')">‚ñ°</div>
                        <div class="control-btn close" onclick="closeWindow('${appId}')">‚úï</div>
                    </div>
                </div>
                <div class="window-content" onmousedown="bringToFront('${appId}')">
                    ${app.content}
                </div>
            `;

            document.getElementById('windows-container').appendChild(win);
            openWindows[appId] = true;
            
            // Mark taskbar as open
            const tbIcon = document.getElementById(`taskbar-${appId}`);
            if(tbIcon) {
                tbIcon.classList.add('open');
                tbIcon.classList.add('active');
            }

            // Init script if any
            if(app.init) setTimeout(() => app.init(appId), 0);

            bringToFront(appId);
        }

        function closeWindow(appId) {
            const win = document.getElementById(`window-${appId}`);
            if(win) win.remove();
            delete openWindows[appId];
            const tbIcon = document.getElementById(`taskbar-${appId}`);
            if(tbIcon) {
                tbIcon.classList.remove('open');
                tbIcon.classList.remove('active');
            }
            
            // Cleanup PS state if closing Photoshop
            if(appId === 'photoshop') {
                psLayers = [];
                activeLayerIndex = -1;
                psCurrentTool = 'brush';
            }
        }

        function minimizeWindow(appId) {
            const win = document.getElementById(`window-${appId}`);
            win.style.display = 'none';
            document.getElementById(`taskbar-${appId}`).classList.remove('active');
        }

        function toggleWindow(appId) {
            if(!openWindows[appId]) {
                openWindow(appId);
            } else {
                const win = document.getElementById(`window-${appId}`);
                if(win.style.display === 'none') {
                    win.style.display = 'flex';
                    bringToFront(appId);
                } else {
                    if (parseInt(win.style.zIndex) === zIndexCounter) {
                        minimizeWindow(appId);
                    } else {
                        bringToFront(appId);
                    }
                }
            }
        }

        function bringToFront(appId) {
            const win = document.getElementById(`window-${appId}`);
            if(win) {
                win.style.zIndex = ++zIndexCounter;
                document.querySelectorAll('.taskbar-icon').forEach(el => el.classList.remove('active'));
                document.getElementById(`taskbar-${appId}`).classList.add('active');
            }
        }

        function toggleMaximize(appId) {
            const win = document.getElementById(`window-${appId}`);
            if (win.style.width === '100%') {
                // Restore
                const app = apps[appId];
                win.style.width = app.width + 'px';
                win.style.height = app.height + 'px';
                win.style.top = '100px'; 
                win.style.left = '100px';
                win.style.borderRadius = '8px';
            } else {
                // Maximize
                win.style.width = '100%';
                win.style.height = 'calc(100% - 48px)'; 
                win.style.top = '0';
                win.style.left = '0';
                win.style.borderRadius = '0';
            }
        }

        // --- Dragging Logic ---
        let isDragging = false;
        let currentDragWin = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        function startDrag(e, appId) {
            if(e.target.closest('.window-controls')) return; 
            isDragging = true;
            currentDragWin = document.getElementById(`window-${appId}`);
            bringToFront(appId);
            
            const rect = currentDragWin.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;
        }

        document.addEventListener('mousemove', (e) => {
            if (isDragging && currentDragWin) {
                if(currentDragWin.style.width === '100%') return; 

                let x = e.clientX - dragOffsetX;
                let y = e.clientY - dragOffsetY;
                
                if (y < 0) y = 0;
                
                currentDragWin.style.left = x + 'px';
                currentDragWin.style.top = y + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            currentDragWin = null;
        });

        // --- Start Menu ---
        function toggleStartMenu() {
            const menu = document.getElementById('start-menu');
            menu.classList.toggle('visible');
            const startBtn = document.querySelector('.start-group .taskbar-icon:first-child');
            if(menu.classList.contains('visible')) {
               startBtn.classList.add('active');
            } else {
               startBtn.classList.remove('active');
            }
        }
        
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('start-menu');
            const startBtn = document.querySelector('.start-group .taskbar-icon:first-child');
            if (!menu.contains(e.target) && !startBtn.contains(e.target)) {
                menu.classList.remove('visible');
                startBtn.classList.remove('active');
            }
        });

        // --- Clock ---
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            const dateStr = now.toLocaleDateString();
            document.getElementById('clock-time').innerText = timeStr;
            document.getElementById('clock-date').innerText = dateStr;
        }

        // --- App Logic ---
        
        // Paint
        let isDrawing = false;
        let ctx = null;
        
        function initPaint() {
            const canvas = document.getElementById('paint-canvas');
            if(!canvas) return;
            ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0,0,700,500);
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }
        
        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }
        function draw(e) {
            if (!isDrawing) return;
            const canvas = document.getElementById('paint-canvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const color = document.getElementById('paint-color').value;
            const size = document.getElementById('paint-size').value;
            
            ctx.lineWidth = size;
            ctx.lineCap = 'round';
            ctx.strokeStyle = color;
            
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }
        function clearCanvas() {
            if (ctx) {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 700, 500);
            }
        }

        // Chrome Logic
        function initChrome() {
            const urlInput = document.getElementById('chrome-url-bar');
            const searchInput = document.getElementById('chrome-search-input');
            const iframe = document.getElementById('chrome-iframe');
            const homeView = document.getElementById('chrome-home-view');

            if (!urlInput || !searchInput) return;

            function performSearch(query) {
                let url = query;
                if (!url.includes('.') || url.includes(' ')) {
                    // Search Query (using Google with igu=1 for iframe support)
                    url = 'https://www.google.com/search?igu=1&q=' + encodeURIComponent(query);
                } else {
                    if (!url.startsWith('http')) {
                        url = 'https://' + url;
                    }
                }
                
                homeView.style.display = 'none';
                iframe.style.display = 'block';
                iframe.src = url;
                urlInput.value = url;
            }

            const handleEnter = (e) => {
                if (e.key === 'Enter') performSearch(e.target.value);
            };

            urlInput.addEventListener('keydown', handleEnter);
            searchInput.addEventListener('keydown', handleEnter);
        }

        function chromeHome() {
            const homeView = document.getElementById('chrome-home-view');
            const iframe = document.getElementById('chrome-iframe');
            const urlInput = document.getElementById('chrome-url-bar');
            const searchInput = document.getElementById('chrome-search-input');
            
            if(homeView) {
                homeView.style.display = 'flex';
                iframe.style.display = 'none';
                iframe.src = '';
                urlInput.value = 'https://www.google.com';
                searchInput.value = '';
            }
        }

        // Calculator
        let calcStr = "";
        function calcAppend(val) {
            if(val === 'C') {
                calcStr = "";
            } else {
                calcStr += val;
            }
            updateCalcDisplay();
        }
        function calcSolve() {
            try {
                // Safe evaluation, though generally discouraged, it's fine for simple calculator
                calcStr = new Function('return ' + calcStr.replace(/√ó/g, '*').replace(/√∑/g, '/'))();
                // If the result is a number, fix to two decimal places
                if (typeof calcStr === 'number') {
                    calcStr = parseFloat(calcStr.toFixed(8)).toString();
                }
            } catch(e) {
                calcStr = "Error";
            }
            updateCalcDisplay();
        }
        function updateCalcDisplay() {
            document.getElementById('calc-display').innerText = calcStr || "0";
        }

        // Photoshop Logic
        const PS_CONFIG = {
            width: 700,
            height: 500
        };
        let psLayers = [];
        let activeLayerIndex = -1;
        let psCurrentTool = 'brush';
        let psIsDrawing = false;
        let psStartPos = { x: 0, y: 0 };
        let psMoveTarget = null;
        let psTempCanvas = null;
        let psTempCtx = null;

        function initPhotoshop(appId) {
            // Setup temporary canvas for shape previews
            psTempCanvas = document.getElementById('ps-temp-canvas');
            psTempCtx = psTempCanvas.getContext('2d');
            
            addNewLayer(true); // Add initial layer
            
            const psCanvasArea = document.getElementById('ps-canvas-area');
            if (psCanvasArea) {
                psCanvasArea.addEventListener('mousedown', psStartAction);
                psCanvasArea.addEventListener('mousemove', psPerformAction);
                psCanvasArea.addEventListener('mouseup', psStopAction);
                psCanvasArea.addEventListener('mouseout', psStopAction);
            }
        }
        
        // Converts RGB(A) to Hex
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }

        function getMousePos(e) {
            // Get the bounding box of the containing area (ps-canvas-area)
            const areaRect = e.currentTarget.getBoundingClientRect();
            
            // Calculate the difference between the area's size and the fixed canvas size
            const offsetX = (areaRect.width - PS_CONFIG.width) / 2;
            const offsetY = (areaRect.height - PS_CONFIG.height) / 2;

            // Calculate mouse position relative to the canvas's drawing space (0,0)
            const x = e.clientX - areaRect.left - offsetX;
            const y = e.clientY - areaRect.top - offsetY;

            return {
                x: Math.round(x),
                y: Math.round(y)
            };
        }
        
        function addNewLayer(isDefault = false) {
            const container = document.getElementById('ps-canvas-area');
            const layersPanel = document.getElementById('ps-layers-panel');
            
            if (!container || !layersPanel) return;

            const newIndex = psLayers.length;
            
            // 1. Create Canvas Element
            const canvas = document.createElement('canvas');
            const layerId = `ps-layer-${newIndex}`;
            canvas.id = layerId;
            canvas.className = 'ps-canvas';
            canvas.width = PS_CONFIG.width;
            canvas.height = PS_CONFIG.height;
            // Z-index: newer layers are on top.
            canvas.style.zIndex = newIndex; 
            
            const ctx = canvas.getContext('2d');
            
            // 2. Clear canvas with transparent color (or white for default)
            if (isDefault) {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, PS_CONFIG.width, PS_CONFIG.height);
            }
            
            // Insert after temp canvas, but before any existing layers (since we prepend later)
            container.appendChild(canvas);

            // 3. Create Layer Item in Panel
            const layerItem = document.createElement('div');
            const layerName = `Layer ${newIndex + 1}`;
            layerItem.className = 'ps-layer-item';
            layerItem.id = `ps-layer-item-${newIndex}`;
            layerItem.setAttribute('data-index', newIndex);
            layerItem.innerHTML = `
                <span>${layerName}</span>
                <span onclick="deleteLayer(${newIndex}, event)">üóëÔ∏è</span>
            `;
            layerItem.onclick = () => switchLayer(newIndex);
            
            layersPanel.prepend(layerItem); // New layers appear at the top

            // 4. Add to Internal State
            psLayers.push({ id: layerId, name: layerName, canvas: canvas, ctx: ctx, index: newIndex });
            
            switchLayer(newIndex);
        }

        function switchLayer(index) {
            if (index < 0 || index >= psLayers.length) return;

            activeLayerIndex = index;

            // Update UI selection
            document.querySelectorAll('.ps-layer-item').forEach(el => el.classList.remove('active'));
            // Find the UI element using the data-index attribute (robust way)
            const item = document.querySelector(`.ps-layer-item[data-index="${index}"]`);
            if (item) item.classList.add('active');
        }

        function deleteLayer(indexToDelete, e) {
            e.stopPropagation();
            if (psLayers.length <= 1) return; 

            // 1. Find the actual layer object using its assigned index
            const layerIndexInArray = psLayers.findIndex(l => l.index === indexToDelete);
            if (layerIndexInArray === -1) return;

            const layer = psLayers[layerIndexInArray];
            if (layer.canvas) layer.canvas.remove();
            
            // 2. Remove UI item
            const layerItem = document.getElementById(`ps-layer-item-${indexToDelete}`);
            if (layerItem) layerItem.remove();

            // 3. Remove from internal state
            psLayers.splice(layerIndexInArray, 1);
            
            // 4. Recalculate z-indices and update UI indices (optional, but keeps things clean)
            // Note: We don't change the actual `index` property, as that keeps a stable UI reference.
            psLayers.forEach((l, i) => {
                l.canvas.style.zIndex = i; // Update visual stacking order
            });

            // 5. Set a new active layer
            activeLayerIndex = -1;
            
            // Find the index of the last remaining layer
            const newActiveIndex = psLayers[psLayers.length - 1] ? psLayers[psLayers.length - 1].index : -1;
            
            if (newActiveIndex !== -1) {
                switchLayer(newActiveIndex);
            }
        }

        function switchTool(iconElement, tool) {
            psCurrentTool = tool;
            document.querySelectorAll('#ps-toolbar .ps-tool-icon').forEach(el => el.classList.remove('active'));
            
            // Only set active state for tools that require drawing/interaction modes
            if (tool !== 'fill') {
                iconElement.classList.add('active');
            }
            
            // Change cursor based on tool
            const canvasArea = document.getElementById('ps-canvas-area');
            if (canvasArea) {
                if (tool === 'brush' || tool === 'eraser' || tool === 'rectangle') {
                    canvasArea.style.cursor = 'crosshair';
                } else if (tool === 'move') {
                    canvasArea.style.cursor = 'move';
                } else {
                    canvasArea.style.cursor = 'default';
                }
            }
        }
        
        function applyFill(pos) {
            if (activeLayerIndex === -1) return;
            const ctx = psLayers[activeLayerIndex].ctx;
            const color = document.getElementById('ps-color-picker').value;

            ctx.fillStyle = color;
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillRect(0, 0, PS_CONFIG.width, PS_CONFIG.height);

            // Revert tool back to brush after filling (standard behavior)
            if (pos) { // Only switch back if triggered by mouse click
                const brushIcon = document.querySelector('.ps-tool-icon[data-tool="brush"]');
                if (brushIcon) switchTool(brushIcon, 'brush');
            }
        }

        function applyEyedropper(pos) {
            if (activeLayerIndex === -1) return;
            const ctx = psLayers[activeLayerIndex].ctx;

            // Get pixel data
            try {
                const pixel = ctx.getImageData(pos.x, pos.y, 1, 1).data;
                const hexColor = rgbToHex(pixel[0], pixel[1], pixel[2]);

                // Update color picker
                const colorPicker = document.getElementById('ps-color-picker');
                colorPicker.value = hexColor.toLowerCase();
                
            } catch (e) {
                console.error("Could not read pixel data (may be cross-origin issue if images were loaded).", e);
            }
            
            // Revert tool back to brush
            const brushIcon = document.querySelector('.ps-tool-icon[data-tool="brush"]');
            if (brushIcon) switchTool(brushIcon, 'brush');
        }


        function psStartAction(e) {
            if (activeLayerIndex === -1) return;
            
            const pos = getMousePos(e);
            psStartPos = pos;
            psIsDrawing = true;
            
            const activeCanvas = psLayers[activeLayerIndex].canvas;
            
            if (psCurrentTool === 'brush' || psCurrentTool === 'eraser') {
                const ctx = psLayers[activeLayerIndex].ctx;
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                psPerformAction(e); // Draw a dot
            } else if (psCurrentTool === 'fill') {
                applyFill(pos);
            } else if (psCurrentTool === 'eyedropper') {
                applyEyedropper(pos);
            } else if (psCurrentTool === 'move') {
                psMoveTarget = e.target.closest('.ps-canvas');
                if (psMoveTarget) {
                    // Calculate offset for moving
                    const rect = psMoveTarget.getBoundingClientRect();
                    psMoveTarget.offsetX = e.clientX - rect.left;
                    psMoveTarget.offsetY = e.clientY - rect.top;
                    psMoveTarget.style.cursor = 'grabbing';
                }
            }
            
        }

        function psPerformAction(e) {
            if (!psIsDrawing || activeLayerIndex === -1) return;
            const pos = getMousePos(e);
            const ctx = psLayers[activeLayerIndex].ctx;
            const color = document.getElementById('ps-color-picker').value;
            const size = document.getElementById('ps-brush-size').value;
            
            if (psCurrentTool === 'brush' || psCurrentTool === 'eraser') {
                
                ctx.lineWidth = size;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                if (psCurrentTool === 'brush') {
                    ctx.strokeStyle = color;
                    ctx.globalCompositeOperation = 'source-over';
                } else if (psCurrentTool === 'eraser') {
                    ctx.strokeStyle = 'rgba(0,0,0,1)';
                    ctx.globalCompositeOperation = 'destination-out';
                }

                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                
            } else if (psCurrentTool === 'move' && psMoveTarget) {
                 let x = e.clientX - psMoveTarget.offsetX;
                 let y = e.clientY - psMoveTarget.offsetY;
                 
                 psMoveTarget.style.left = `${x}px`;
                 psMoveTarget.style.top = `${y}px`;
                 
            } else if (psCurrentTool === 'rectangle') {
                // Draw preview on temp canvas
                psTempCtx.clearRect(0, 0, PS_CONFIG.width, PS_CONFIG.height);

                const width = pos.x - psStartPos.x;
                const height = pos.y - psStartPos.y;

                psTempCtx.strokeStyle = color;
                psTempCtx.lineWidth = 2;
                psTempCtx.strokeRect(psStartPos.x, psStartPos.y, width, height);
            }
        }

        function psStopAction(e) {
            if (!psIsDrawing || activeLayerIndex === -1) return;
            const pos = getMousePos(e);
            psIsDrawing = false;
            
            if (psCurrentTool === 'brush' || psCurrentTool === 'eraser') {
                psLayers[activeLayerIndex].ctx.beginPath();
            } else if (psCurrentTool === 'move') {
                if (psMoveTarget) psMoveTarget.style.cursor = 'move';
                psMoveTarget = null;
            } else if (psCurrentTool === 'rectangle') {
                // 1. Clear preview
                psTempCtx.clearRect(0, 0, PS_CONFIG.width, PS_CONFIG.height);
                
                // 2. Draw final rectangle on the active layer
                const ctx = psLayers[activeLayerIndex].ctx;
                const color = document.getElementById('ps-color-picker').value;
                const size = document.getElementById('ps-brush-size').value;

                const width = pos.x - psStartPos.x;
                const height = pos.y - psStartPos.y;

                ctx.strokeStyle = color;
                ctx.lineWidth = size / 5; // Smaller line for shapes
                ctx.globalCompositeOperation = 'source-over';
                
                ctx.strokeRect(psStartPos.x, psStartPos.y, width, height);
            }
            
        }
        
        function applyGrayscale() {
            if (activeLayerIndex === -1) return;
            // Need the index in the actual array, not the assigned 'index' property
            const layerIndexInArray = psLayers.findIndex(l => l.index === psLayers[activeLayerIndex].index);
            if (layerIndexInArray === -1) return;

            const ctx = psLayers[layerIndexInArray].ctx;
            const imageData = ctx.getImageData(0, 0, PS_CONFIG.width, PS_CONFIG.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                // Skip fully transparent pixels
                if (data[i + 3] === 0) continue; 
                
                // Luminosity method for grayscale
                const avg = 0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2];
                data[i] = avg;     // Red
                data[i + 1] = avg; // Green
                data[i + 2] = avg; // Blue
            }

            ctx.putImageData(imageData, 0, 0);
        }


        // Boot
        window.onload = init;

    </script>
</body>
</html>
